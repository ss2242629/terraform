name: terraform deployment

on:
  push:
    branches:
      - master

jobs:
  deploy_dev:
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && github.event.ref_type == 'branch' && github.event.ref == 'refs/heads/master'
    runs-on: ubuntu_latest
    strategy: 
      matrix: 
        environment: ['dev', 'state', 'prod']
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 3.59.0

      - name: Azure login
        uses: azure/login@v1
        with: 
          creds: ${{ secrets.ARM_CLIENT_SECRET }}
          args: --service-principal --tenant ${{ secrets.ARM_TENANT_ID }} --service-principal-id ${{ secrets.ARM_CLIENT_ID}} --subscriptions ${{ secrets.ARM_SUBSCRIPTION_ID }} 
           
      - name: Terraform init dev
        if: github.ref == 'refs/heads/master' && github.event_name == 'push' && github.event.ref_type == 'branch' && github.event.ref == 'refs/heads/master'
        run: terraform chdir=environment/dev init

      - name: Terraform plan dev
        if: github.ref == 'refs/heads/master' && github.event_name == 'push' && github.event.ref_type == 'branch' && github.event.ref == 'refs/heads/master'
        run: terraform chdir=environment/dev plan -out=tfplan

      - name: Terraform apply dev
        if: github.ref == 'refs/heads/master' && github.event_name == 'push' && github.event.ref_type == 'branch' && github.event.ref == 'refs/heads/master'
        run: terraform chdir=environment/dev apply tfplan -auto-approve
        
      
      
           
           
         
        
          

